<%- include('partials/header') %>

    <div class="container mt-4">
        <h1 class="text-center mb-4">❤️ My Favorite Books</h1>

        <div class="books-container">
            <% if (books.length===0) { %>
                <div class="text-center w-100 py-5">
                    <p class="text-muted fs-4">You haven't favorited any books yet.</p>
                    <a href="/" class="btn btn-primary mt-3">Browse Books</a>
                </div>
                <% } else { %>
                    <% books.forEach(book=> { %>
                        <div class="book-card">
                            <% if (book.isbn) { %>
                                <div style="position: relative;">
                                    <img src="https://covers.openlibrary.org/b/isbn/<%= book.isbn %>-M.jpg"
                                        alt="Book Cover">
                                    <button class="fav-btn" data-id="<%= book.id %>"
                                        style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: transform 0.2s;">
                                        ❤️
                                    </button>
                                </div>
                                <% } %>

                                    <h2>
                                        <%= book.title %>
                                    </h2>
                                    <p><strong>Author:</strong>
                                        <%= book.author %>
                                    </p>
                                    <p><strong>Rating:</strong> ⭐ <%= book.rating %>/5</p>
                                    <p class="notes">
                                        <%= book.notes %>
                                    </p>

                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <% if (locals.user && locals.user.is_admin) { %>
                                            <a href="/edit/<%= book.id %>" class="edit-btn"
                                                style="text-decoration: none; padding: 8px 12px; background: #FFC107; color: black; border-radius: 5px; font-size: 14px;">✏
                                                Edit</a>
                                            <% } %>
                                    </div>
                        </div>
                        <% }) %>
                            <% } %>
        </div>
    </div>

    <script>
        document.querySelectorAll('.fav-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const bookId = btn.getAttribute('data-id');
                try {
                    const response = await fetch('/favorite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bookId })
                    });
                    const data = await response.json();
                    if (data.success) {
                        if (!data.favorited) {
                            // If on favorites page, remove the card
                            btn.closest('.book-card').style.opacity = '0';
                            btn.closest('.book-card').style.transform = 'scale(0.9)';
                            setTimeout(() => {
                                btn.closest('.book-card').remove();
                                if (document.querySelectorAll('.book-card').length === 0) {
                                    location.reload();
                                }
                            }, 300);
                        }
                    }
                } catch (err) {
                    console.error('Error toggling favorite:', err);
                }
            });
        });
    </script>

    <%- include('partials/footer') %>