<%- include('partials/header') %>

  <div class="container mt-4">
    <div class="top-bar d-flex justify-content-between align-items-center mb-4">
      <form action="/" method="GET" class="search-form" style="display:inline-block;">
        <input type="text" name="search" placeholder="Search books..."
          style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
        <button type="submit"
          style="padding: 8px 12px; border-radius: 4px; background: #007bff; color: white; border: none; cursor: pointer;">üîç</button>
        <% if (typeof books !=='undefined' && books.length===0) { %>
          <a href="/" style="margin-left: 10px; color: #007bff; text-decoration: none;">Clear Search</a>
          <% } %>
      </form>

      <div class="sort-bar mb-0">
        <a href="/?sort=recent">üïí Recent</a>
        <a href="/?sort=rating">‚≠ê Rating</a>
        <a href="/?sort=title">üî§ Title</a>
      </div>
    </div>

    <h1 class="text-center mb-4">üìö My Book Notes</h1>

    <% if (typeof error !=="undefined" ) { %>
      <div class="error-box">
        <%= error %>
      </div>
      <% } %>

        <% if (typeof message !=="undefined" ) { %>
          <div class="success-box"
            style="background: #e6fffa; color: #00796b; padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: center;">
            <%= message %>
          </div>
          <% } %>

            <div class="books-container">
              <% books.forEach(book=> { %>
                <div class="book-card">

                  <% if (book.isbn) { %>
                    <div style="position: relative;">
                      <img src="https://covers.openlibrary.org/b/isbn/<%= book.isbn %>-M.jpg" alt="Book Cover">
                      <button class="fav-btn" data-id="<%= book.id %>"
                        style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: transform 0.2s;">
                        <%= book.is_favourite ? '‚ù§Ô∏è' : 'ü§ç' %>
                      </button>
                    </div>
                    <% } %>

                      <h2>
                        <%= book.title %>
                      </h2>
                      <p><strong>Author:</strong>
                        <%= book.author %>
                      </p>
                      <p><strong>Rating:</strong> ‚≠ê <%= book.rating %>/5</p>
                      <p><strong>Read on:</strong>
                        <%= book.read_date %>
                      </p>
                      <p class="notes">
                        <%= book.notes %>
                      </p>

                      <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <% if (locals.user && locals.user.is_admin) { %>
                          <a href="/edit/<%= book.id %>" class="edit-btn"
                            style="text-decoration: none; padding: 8px 12px; background: #FFC107; color: black; border-radius: 5px; font-size: 14px;">‚úè
                            Edit</a>
                          <form action="/delete" method="POST" style="margin: 0;">
                            <input type="hidden" name="id" value="<%= book.id %>">
                            <button type="submit" class="delete-btn">üóë Delete</button>
                          </form>
                          <% } %>
                      </div>

                </div>
                <% }) %>
            </div>

            <div class="pagination"
              style="display: flex; justify-content: center; gap: 10px; margin-top: 30px; flex-wrap: wrap;">
              <% if (currentPage> 1) { %>
                <a href="/?page=1<% if (search) { %>&search=<%= search %><% } %><% if (selectedSort) { %>&sort=<%= selectedSort %><% } %>"
                  class="page-btn">¬´ First</a>
                <a href="/?page=<%= currentPage - 1 %><% if (search) { %>&search=<%= search %><% } %><% if (selectedSort) { %>&sort=<%= selectedSort %><% } %>"
                  class="page-btn">‚Äπ Prev</a>
                <% } %>

                  <% for (let i=Math.max(1, currentPage - 2); i <=Math.min(totalPages, currentPage + 2); i++) { %>
                    <% if (i===currentPage) { %>
                      <span class="page-btn active" style="background: #007bff; color: white; cursor: default;">
                        <%= i %>
                      </span>
                      <% } else { %>
                        <a href="/?page=<%= i %><% if (search) { %>&search=<%= search %><% } %><% if (selectedSort) { %>&sort=<%= selectedSort %><% } %>"
                          class="page-btn">
                          <%= i %>
                        </a>
                        <% } %>
                          <% } %>

                            <% if (currentPage < totalPages) { %>
                              <a href="/?page=<%= currentPage + 1 %><% if (search) { %>&search=<%= search %><% } %><% if (selectedSort) { %>&sort=<%= selectedSort %><% } %>"
                                class="page-btn">Next ‚Ä∫</a>
                              <a href="/?page=<%= totalPages %><% if (search) { %>&search=<%= search %><% } %><% if (selectedSort) { %>&sort=<%= selectedSort %><% } %>"
                                class="page-btn">Last ¬ª</a>
                              <% } %>
            </div>

            <div style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
              Page <%= currentPage %> of <%= totalPages %> | <%= totalBooks %> total books
            </div>

  </div>
  <script>
    document.querySelectorAll('.fav-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const bookId = btn.getAttribute('data-id');
        try {
          const response = await fetch('/favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bookId })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `Server error: ${response.status}`);
          }

          const data = await response.json();
          if (data.success) {
            btn.innerHTML = data.favorited ? '‚ù§Ô∏è' : 'ü§ç';
            btn.style.transform = 'scale(1.2)';
            setTimeout(() => btn.style.transform = 'scale(1)', 200);
          }
        } catch (err) {
          console.error('Error toggling favorite:', err);
        }
      });
    });
  </script>
  <%- include('partials/footer') %>